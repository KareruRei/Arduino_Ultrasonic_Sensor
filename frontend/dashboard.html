<html>
<head>
    <meta charset="utf-8">
    <title>Radar Control System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="img/icon.png">
</head>

<body>
    <header class="topbar">
        <div class="title">RADAR CONTROL SYSTEM</div>
        <div class="clock" id="clock"></div>
    </header>

    <section class="dashboard">
        <div class="grid">
            <div class="item item-0" id="radar"></div>
            <div class="item item-1">
                <div class="activity">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="item item-2">
                <div class="hud-container">
                    <div class="hud-label">DIRECTIONAL THREAT SENSOR</div>
                    <div class="compass-strip" id="compassHUD">
                        <div class="center-line"></div>
                    </div>
                    <div class="hud-readout">
                        ACTIVE SCAN: <span id="current-angle">180°</span>
                    </div>
                </div>
            </div>
        </div> 
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script>
function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent = now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

let ws;
let statusSpan = null;
const API_BASE_URL = "http://localhost/arduino-sensor-backend";
const WS_URL = "ws://localhost:8080";

function initWebSocket() {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        console.log("Connected to WebSocket backend");
        ws.send(JSON.stringify({ role: "client" }));
        updateConnectionStatus(true);
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            handleSensorData(data);
        } catch (e) {
            console.error("Failed to parse message:", event.data, e);
        }
    };

    ws.onerror = err => {
        console.error("WS error", err);
        updateConnectionStatus(false);
    };

    ws.onclose = () => {
        console.log("Disconnected from WebSocket backend");
        updateConnectionStatus(false);
        setTimeout(initWebSocket, 3000);
    };
}

function updateConnectionStatus(isConnected) {
    if (statusSpan) {
        statusSpan.textContent = isConnected ? "Connected" : "Disconnected";
        statusSpan.style.color = isConnected ? "#00ff41" : "#ff4141";
    }
}

// Fetch historical sensor logs from REST API
async function loadHistoricalLogs() {
    try {
        const response = await fetch(`${API_BASE_URL}/get-logs.php?type=sensor`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const logs = await response.json();
        
        // Process historical logs - add them to the activity table
        logs.forEach(log => {
            // logs are arrays from fetchAll(PDO::FETCH_NUM)
            // Format: [id, sensor, sensor_data, created_at]
            addHistoricalActivityEntry(log);
        });
        
        console.log("Loaded " + logs.length + " historical sensor logs");
    } catch (error) {
        console.error("Failed to load historical logs:", error);
    }
}

// Fetch event logs from REST API
async function loadEventLogs() {
    try {
        const response = await fetch(`${API_BASE_URL}/get-logs.php?type=event`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const events = await response.json();
        console.log("Loaded " + events.length + " event logs");
    } catch (error) {
        console.error("Failed to load event logs:", error);
    }
}

// Submit sensor data to backend
async function submitSensorData(sensorData) {
    try {
        const response = await fetch(`${API_BASE_URL}/post-logs.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(sensorData)
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        console.log("Sensor data submitted successfully");
    } catch (error) {
        console.error("Failed to submit sensor data:", error);
    }
}

// Initialize on page load
window.addEventListener('load', () => {
    initWebSocket();
    loadHistoricalLogs();
    loadEventLogs();
});

let angle = 180; 
let targets = [];
let moveDirection = 1; 
let scanSpeed = 0.5;   

function handleSensorData(data) {
    if (data.sensor === 'Ultrasonic Sensor' && data.distance !== undefined) {
        let targetIndex = targets.findIndex(t => t.angle === data.angle);
        
        if (targetIndex === -1) {
            targets.push({
                angle: data.angle || 0,
                distance: (data.distance || 0) / 1000, // Normalize distance to 0-1 range
                visible: false
            });
        } else {
            targets[targetIndex].distance = (data.distance || 0) / 1000;
        }

        // Add activity entry to table
        addActivityEntry(data);
    }
}

function addActivityEntry(data) {
    const table = document.querySelector('.item-1 table tbody');
    
    // Create tbody if it doesn't exist
    if (!table) {
        const tbody = document.createElement('tbody');
        document.querySelector('.item-1 table').appendChild(tbody);
    }

    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    
    // Determine activity based on distance (less than 400cm = threat)
    const distance = data.distance || 0;
    const activity = distance < 400 ? `THREAT DETECTED - ${Math.round(distance)}cm` : `CLEAR - ${Math.round(distance)}cm`;
    
    // Create new row
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${timeStr}</td>
        <td>${activity}</td>
    `;
    
    // Add row to top of tbody
    const tbody = document.querySelector('.item-1 table tbody');
    tbody.insertBefore(row, tbody.firstChild);
    
    // Keep only last 50 entries
    while (tbody.children.length > 50) {
        tbody.removeChild(tbody.lastChild);
    }
}

function addHistoricalActivityEntry(log) {
    const table = document.querySelector('.item-1 table tbody');
    
    // Create tbody if it doesn't exist
    if (!table) {
        const tbody = document.createElement('tbody');
        document.querySelector('.item-1 table').appendChild(tbody);
        return; // Return early if we just created tbody
    }

    // Parse log array: [id, sensor, sensor_data, created_at]
    const createdAt = log[3] ? new Date(log[3]).toLocaleTimeString() : 'N/A';
    const sensorData = JSON.parse(log[2] || '{}');
    const distance = sensorData.distance || 0;
    
    // Determine activity based on distance
    const activity = distance < 400 ? `THREAT DETECTED - ${Math.round(distance)}cm` : `CLEAR - ${Math.round(distance)}cm`;
    
    // Create new row
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${createdAt}</td>
        <td>${activity}</td>
    `;
    
    // Add row to tbody
    const tbody = document.querySelector('.item-1 table tbody');
    tbody.appendChild(row);
}

function setup() {
    const div = document.getElementById("radar");
    if(div.offsetHeight === 0) div.style.height = "300px";

    const canvas = createCanvas(div.clientWidth, div.clientHeight);
    canvas.parent("radar");
    angleMode(DEGREES);
}

function updateHUD() {
    const hud = document.getElementById("compassHUD");
    hud.querySelectorAll('.threat-marker').forEach(m => m.remove());

    targets.forEach(t => {
        if (!t.visible) return;

        let percent = map(t.angle, 180, 360, 0, 100);
        let marker = document.createElement("div");
        marker.className = "threat-marker";
        marker.style.position = "absolute";
        marker.style.left = percent + "%";
        marker.style.width = "4px";
        marker.style.height = "100%";
        
        marker.style.background = t.distance < 0.4 ? "red" : "#00ff00";
        if(t.distance < 0.4) marker.style.boxShadow = "0 0 8px red";
        
        hud.appendChild(marker);
    });
}

function draw() {
    background(0, 30); 
    const r = min(width, height * 2) * 0.8;
    translate(width / 2, height * 0.9);

    stroke(0, 255, 0, 100);
    noFill();
    for (let i = 1; i <= 4; i++) {
        let diameter = (r * i) / 4;
        arc(0, 0, diameter, diameter, 180, 360);
    }
    line(-r/2, 0, r/2, 0);

    targets.forEach(t => {
        const x = (r/2 * t.distance) * cos(t.angle);
        const y = (r/2 * t.distance) * sin(t.angle);
        
        if (abs(angle - t.angle) < scanSpeed * 2) {
            t.visible = true;
        }

        if (t.visible) {
            noStroke();
            fill(t.distance < 0.4 ? [255, 0, 0] : [0, 255, 0]);
            circle(x, y, 8);
        }
    });

    const sx = r/2 * cos(angle);
    const sy = r/2 * sin(angle);
    stroke(0, 255, 0);
    strokeWeight(2);
    line(0, 0, sx, sy);

    angle += (scanSpeed * moveDirection);
    
    if (angle >= 360 || angle <= 180) {
        moveDirection *= -1; 
    }

    document.getElementById("current-angle").textContent = Math.floor(angle) + "°";
    updateHUD();
}

function windowResized() {
    const div = document.getElementById("radar");
    resizeCanvas(div.clientWidth, div.clientHeight);
}

</script>
</body>
</html>
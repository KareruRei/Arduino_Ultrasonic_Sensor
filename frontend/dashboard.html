<html>
<head>
    <meta charset="utf-8">
    <title>Radar Control System</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header class="topbar">
        <div class="title">RADAR CONTROL SYSTEM</div>
        <div class="clock" id="clock"></div>
    </header>

    <section class="dashboard">
        <div class="grid">
            <div class="item item-0" id="radar"></div>
            <div class="item item-1">
                <div class="activity">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="item item-2">
                <div class="hud-container">
                    <div class="hud-label">DIRECTIONAL THREAT SENSOR</div>
                    <div class="compass-strip" id="compassHUD">
                        <div class="center-line"></div>
                    </div>
                    <div class="hud-readout">
                        ACTIVE SCAN: <span id="current-angle">180°</span>
                    </div>
                </div>
            </div>
        </div> 
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script>
function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent = now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

let ws;
let statusSpan = null;

function initWebSocket() {
    const wsUrl = "ws://localhost:8080";
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        console.log("Connected to backend");
        ws.send(JSON.stringify({ role: "client" }));
        updateConnectionStatus(true);
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            handleSensorData(data);
        } catch (e) {
            console.error("Failed to parse message:", event.data, e);
        }
    };

    ws.onerror = err => {
        console.error("WS error", err);
        updateConnectionStatus(false);
    };

    ws.onclose = () => {
        console.log("Disconnected from backend");
        updateConnectionStatus(false);
        // Try to reconnect after 3 seconds
        setTimeout(initWebSocket, 3000);
    };
}
// Initialize WebSocket connection on page load
window.addEventListener('load', initWebSocket);

let angle = 180; 
let targets = [];
let moveDirection = 1; 
let scanSpeed = 0.5;   

function handleSensorData(data) {
    // Handle incoming sensor data from Arduino
    if (data.sensor === 'Ultrasonic Sensor' && data.distance !== undefined) {
        // Add to targets for radar visualization
        let targetIndex = targets.findIndex(t => t.angle === data.angle);
        
        if (targetIndex === -1) {
            targets.push({
                angle: data.angle || 0,
                distance: (data.distance || 0) / 1000, // Normalize distance to 0-1 range
                visible: false
            });
        } else {
            targets[targetIndex].distance = (data.distance || 0) / 1000;
        }

        // Add activity entry to table
        addActivityEntry(data);
    }
}

function addActivityEntry(data) {
    const table = document.querySelector('.item-1 table tbody');
    
    // Create tbody if it doesn't exist
    if (!table) {
        const tbody = document.createElement('tbody');
        document.querySelector('.item-1 table').appendChild(tbody);
    }

    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    
    // Determine activity based on distance (less than 400cm = threat)
    const distance = data.distance || 0;
    const activity = distance < 400 ? `THREAT DETECTED - ${Math.round(distance)}cm` : `CLEAR - ${Math.round(distance)}cm`;
    
    // Create new row
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${timeStr}</td>
        <td>${activity}</td>
    `;
    
    // Add row to top of tbody
    const tbody = document.querySelector('.item-1 table tbody');
    tbody.insertBefore(row, tbody.firstChild);
    
    // Keep only last 50 entries
    while (tbody.children.length > 50) {
        tbody.removeChild(tbody.lastChild);
    }
}

function setup() {
    const div = document.getElementById("radar");
    if(div.offsetHeight === 0) div.style.height = "300px";

    const canvas = createCanvas(div.clientWidth, div.clientHeight);
    canvas.parent("radar");
    angleMode(DEGREES);
}

function updateHUD() {
    const hud = document.getElementById("compassHUD");
    hud.querySelectorAll('.threat-marker').forEach(m => m.remove());

    targets.forEach(t => {
        if (!t.visible) return;

        let percent = map(t.angle, 180, 360, 0, 100);
        let marker = document.createElement("div");
        marker.className = "threat-marker";
        marker.style.position = "absolute";
        marker.style.left = percent + "%";
        marker.style.width = "4px";
        marker.style.height = "100%";
        
        marker.style.background = t.distance < 0.4 ? "red" : "#00ff00";
        if(t.distance < 0.4) marker.style.boxShadow = "0 0 8px red";
        
        hud.appendChild(marker);
    });
}

function draw() {
    background(0, 30); 
    const r = min(width, height * 2) * 0.8;
    translate(width / 2, height * 0.9);

    stroke(0, 255, 0, 100);
    noFill();
    for (let i = 1; i <= 4; i++) {
        let diameter = (r * i) / 4;
        arc(0, 0, diameter, diameter, 180, 360);
    }
    line(-r/2, 0, r/2, 0);

    targets.forEach(t => {
        const x = (r/2 * t.distance) * cos(t.angle);
        const y = (r/2 * t.distance) * sin(t.angle);
        
        if (abs(angle - t.angle) < scanSpeed * 2) {
            t.visible = true;
        }

        if (t.visible) {
            noStroke();
            fill(t.distance < 0.4 ? [255, 0, 0] : [0, 255, 0]);
            circle(x, y, 8);
        }
    });

    const sx = r/2 * cos(angle);
    const sy = r/2 * sin(angle);
    stroke(0, 255, 0);
    strokeWeight(2);
    line(0, 0, sx, sy);

    angle += (scanSpeed * moveDirection);
    
    if (angle >= 360 || angle <= 180) {
        moveDirection *= -1; 
    }

    document.getElementById("current-angle").textContent = Math.floor(angle) + "°";
    updateHUD();
}

function windowResized() {
    const div = document.getElementById("radar");
    resizeCanvas(div.clientWidth, div.clientHeight);
}

</script>
</body>
</html>